{% extends 'baseadmin.html' %}
{% block title %}Lista de Productos{% endblock %}
{% block body %}

<div class="container-fluid p-4" style="background-color:#eefaf5; min-height:100vh;">

    <!-- Letrero con sombra -->
    <h2 class="text-center alert-productos mb-4">Lista de Cursos</h2>

    <!-- Controles superiores -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <button class="btn btn-light border me-2 shadow-sm" title="Copiar" id="btnCopiar">
                <i class="fas fa-copy"></i>
            </button>
            <button class="btn btn-light border me-2 shadow-sm" title="Exportar a Excel" id="btnExcel">
                <i class="fas fa-file-excel"></i>
            </button>
            <button class="btn btn-light border me-2 shadow-sm" title="Exportar a PDF" id="btnPDF">
                <i class="fas fa-file-pdf"></i>
            </button>
            <button class="btn btn-light border shadow-sm" title="Imprimir" id="btnImprimir">
                <i class="fas fa-print"></i>
            </button>
        </div>
        <div class="d-flex align-items-center">
            <span class="me-2">Mostrar</span>
            <select id="registrosSelect" class="form-select form-select-sm me-2 shadow-sm" style="width:80px;">
                <option>5</option>
                <option selected>10</option>
                <option>25</option>
                <option>50</option>
            </select>
            <span class="me-3">registros</span>
            <label for="searchInput" class="me-2">Buscar:</label>
            <input type="text" id="searchInput" name="search" class="form-control form-control-sm shadow-sm"
                style="width:200px;" placeholder="Buscar...">
        </div>
    </div>

    <!-- Tabla de productos con sombra -->
    <div class="table-responsive shadow p-2 bg-white rounded">
        <table class="table table-striped table-bordered table-hover" id="productosTable">
            <thead class="table-dark text-center">
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Precio</th>
                    <th>Descripción</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for producto in productos %}
                <tr>
                    <td class="text-center">{{ producto.id }}</td>
                    <form method="POST" action="{{ url_for('editar_producto', id=producto.id) }}">
                        <td>
                            <input type="text" name="nombre" value="{{ producto.nombre }}"
                                class="form-control form-control-sm">
                        </td>
                        <td>
                            <input type="number" step="0.01" name="precio" value="{{ producto.precio }}"
                                class="form-control form-control-sm text-end">
                        </td>
                        <td>
                            <input type="text" name="descripcion" value="{{ producto.descripcion }}"
                                class="form-control form-control-sm">
                        </td>
                        <td class="text-center">
                            <form method="POST" action="">
                                <form method="POST" action="">
                                    <button type="button" class="btn btn-success btn-sm me-1 shadow-sm" title="Guardar"
                                        onclick="confirmarGuardado(this.form)">
                                        <i class="fas fa-pen"></i>
                                    </button>



                                    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
                                    <script>
                                        function confirmarGuardado(form) {
                                            Swal.fire({
                                                title: '¿Deseas guardar los cambios?',
                                                icon: 'question',
                                                showCancelButton: true,
                                                confirmButtonColor: '#28a745',
                                                cancelButtonColor: '#6c757d',
                                                confirmButtonText: 'Sí, guardar',
                                                cancelButtonText: 'Cancelar'
                                            }).then((result) => {
                                                if (result.isConfirmed) {
                                                    // Creamos un input oculto para indicar la acción "guardar"
                                                    let input = document.createElement("input");
                                                    input.type = "hidden";
                                                    input.name = "accion";
                                                    input.value = "guardar";
                                                    form.appendChild(input);

                                                    form.submit();
                                                }
                                            });
                                        }


                                    </script>


                                    <button type="button" class="btn btn-danger btn-sm shadow-sm" title="Eliminar"
                                        onclick="confirmarEliminacion(this.form)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>

                                <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
                                <script>
                                    function confirmarEliminacion(form) {
                                        Swal.fire({
                                            title: '¿Estás seguro?',
                                            text: "¡Esta acción no se puede deshacer!",
                                            icon: 'warning',
                                            showCancelButton: true,
                                            confirmButtonColor: '#d33',
                                            cancelButtonColor: '#3085d6',
                                            confirmButtonText: 'Sí, eliminar',
                                            cancelButtonText: 'Cancelar'
                                        }).then((result) => {
                                            if (result.isConfirmed) {
                                                // Creamos un input oculto para indicar la acción "eliminar"
                                                let input = document.createElement("input");
                                                input.type = "hidden";
                                                input.name = "accion";
                                                input.value = "eliminar";
                                                form.appendChild(input);

                                                form.submit();
                                            }
                                        });
                                    }
                                </script>

                        </td>
                    </form>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Paginación -->
    <div class="d-flex justify-content-between align-items-center mt-2">
        <div id="infoPagina">Mostrando 1 a 10 de {{ productos|length }} registros</div>
        <nav>
            <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
        </nav>
    </div>

</div>

<!-- Estilos -->
<style>
    body {
        background-color: #eefaf5;
    }

    .alert-productos {
        background-color: #f8d7da;
        color: #721c24;
        font-weight: bold;
        font-size: 1.4rem;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        padding: 15px;
    }

    .table th,
    .table td {
        vertical-align: middle !important;
    }

    .btn-success {
        background-color: #28a745;
        border: none;
    }

    .btn-danger {
        background-color: #dc3545;
        border: none;
    }

    .btn-light i {
        font-size: 1.1rem;
    }

    .shadow-sm {
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15) !important;
    }

    .shadow {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2) !important;
    }
</style>

<!-- Scripts -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script>
    const searchInput = document.getElementById('searchInput');
    const registrosSelect = document.getElementById('registrosSelect');
    const tableBody = document.querySelector('#productosTable tbody');
    let allRows = Array.from(tableBody.querySelectorAll('tr'));
    const pagination = document.getElementById('pagination');
    const infoPagina = document.getElementById('infoPagina');
    let currentPage = 1;

    // ===== Filtrar y paginar =====
    function filtrarYPaginar() {
        const filter = searchInput.value.toLowerCase();
        const rowsPerPage = parseInt(registrosSelect.value);

        let filteredRows = allRows.filter(row => {
            const nombreInput = row.querySelector('input[name="nombre"]');
            const nombre = nombreInput ? nombreInput.value.toLowerCase() : '';
            const id = row.querySelector('td:first-child')?.textContent.toLowerCase() || '';
            return id.includes(filter) || nombre.includes(filter);
        });

        const pageCount = Math.ceil(filteredRows.length / rowsPerPage);
        if (currentPage > pageCount) currentPage = 1;
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;

        allRows.forEach(row => row.style.display = 'none');
        filteredRows.slice(start, end).forEach(row => row.style.display = '');

        const showingStart = filteredRows.length === 0 ? 0 : start + 1;
        const showingEnd = Math.min(end, filteredRows.length);
        infoPagina.textContent = `Mostrando ${showingStart} a ${showingEnd} de ${filteredRows.length} registros`;

        // Paginación
        pagination.innerHTML = '';
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#">«</a>`;
        prevLi.addEventListener('click', () => { if (currentPage > 1) { currentPage--; filtrarYPaginar(); } });
        pagination.appendChild(prevLi);

        for (let i = 1; i <= pageCount; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentPage ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
            li.addEventListener('click', () => { currentPage = i; filtrarYPaginar(); });
            pagination.appendChild(li);
        }

        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === pageCount ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#">»</a>`;
        nextLi.addEventListener('click', () => { if (currentPage < pageCount) { currentPage++; filtrarYPaginar(); } });
        pagination.appendChild(nextLi);
    }

    searchInput.addEventListener('keyup', () => { currentPage = 1; filtrarYPaginar(); });
    registrosSelect.addEventListener('change', () => { currentPage = 1; filtrarYPaginar(); });
    filtrarYPaginar();

    // ===== Botones funcionales =====

   // Copiar tabla
document.getElementById('btnCopiar').addEventListener('click', () => {
    let text = '';
    allRows.forEach(row => {
        if (row.style.display !== 'none') { // Solo filas visibles
            const cells = Array.from(row.cells).map(cell => {
                const input = cell.querySelector('input');
                if (input) return input.value.trim(); // Si hay input, tomamos su valor
                else {
                    // Tomamos solo texto directo del nodo, ignorando HTML interno
                    return Array.from(cell.childNodes)
                        .filter(node => node.nodeType === Node.TEXT_NODE)
                        .map(node => node.textContent.trim())
                        .join(' ');
                }
            });
            text += cells.join('\t') + '\n';
        }
    });
    navigator.clipboard.writeText(text).then(() => alert('Tabla copiada al portapapeles'));
});



    // Exportar a Excel
    document.getElementById('btnExcel').addEventListener('click', () => {
        const ws_data = [];
        // Cabecera
        const headers = Array.from(document.querySelectorAll('#productosTable thead th')).map(th => th.innerText);
        ws_data.push(headers);
        // Filas
        allRows.forEach(row => {
            const rowData = Array.from(row.cells).map(cell => {
                const input = cell.querySelector('input');
                return input ? input.value : cell.innerText;
            });
            ws_data.push(rowData);
        });
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        XLSX.utils.book_append_sheet(wb, ws, 'Productos');
        XLSX.writeFile(wb, 'productos.xlsx');
    });

    // Exportar a PDF
    document.getElementById('btnPDF').addEventListener('click', () => {
        const w = window.open('', '', 'height=600,width=800');
        w.document.write('<html><head><title>PDF</title></head><body>');
        w.document.write(document.getElementById('productosTable').outerHTML);
        w.document.write('</body></html>');
        w.document.close();
        w.print();
    });

    // Imprimir
    document.getElementById('btnImprimir').addEventListener('click', () => {
        const w = window.open('', '', 'height=600,width=800');
        w.document.write('<html><head><title>Imprimir</title></head><body>');
        w.document.write(document.getElementById('productosTable').outerHTML);
        w.document.write('</body></html>');
        w.document.close();
        w.print();
    });
</script>

{% endblock %}