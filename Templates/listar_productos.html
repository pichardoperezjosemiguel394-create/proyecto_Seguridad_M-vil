{% extends 'baseadmin.html' %}
{% block title %}Lista de Técnicas{% endblock %}
{% block body %}

<div class="container-fluid p-4" style="background-color:#f8f9fa; min-height:100vh;">

    <!-- Letrero con sombra -->
    <h2 class="text-center alert-tecnicas mb-4">Lista de Técnicas</h2>

    <!-- Controles superiores -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <button class="btn border me-2 shadow-sm btn-copiar" 
                    title="Copiar tabla al portapapeles" 
                    data-bs-toggle="tooltip" data-bs-placement="top"
                    id="btnCopiar">
                <i class="fas fa-copy"></i> Copiar
            </button>
            <button class="btn border me-2 shadow-sm btn-excel" 
                    title="Exportar tabla a Excel" 
                    data-bs-toggle="tooltip" data-bs-placement="top"
                    id="btnExcel">
                <i class="fas fa-file-excel"></i> Excel
            </button>
            <button class="btn border me-2 shadow-sm btn-pdf" 
                    title="Generar PDF de la tabla" 
                    data-bs-toggle="tooltip" data-bs-placement="top"
                    id="btnPDF">
                <i class="fas fa-file-pdf"></i> PDF
            </button>
            <button class="btn border shadow-sm btn-imprimir" 
                    title="Imprimir tabla" 
                    data-bs-toggle="tooltip" data-bs-placement="top"
                    id="btnImprimir">
                <i class="fas fa-print"></i> Imprimir
            </button>
        </div>
        <div class="d-flex align-items-center">
            <span class="me-2" data-bs-toggle="tooltip" data-bs-placement="top" 
                  title="Selecciona cuántos registros mostrar por página">Mostrar</span>
            <select id="registrosSelect" 
                    class="form-select form-select-sm me-2 shadow-sm" 
                    style="width:80px;"
                    data-bs-toggle="tooltip" data-bs-placement="top"
                    title="Registros por página">
                <option>5</option>
                <option selected>10</option>
                <option>25</option>
                <option>50</option>
            </select>
            <span class="me-3">registros</span>
            <label for="searchInput" class="me-2" 
                   data-bs-toggle="tooltip" data-bs-placement="top"
                   title="Buscar en todos los campos de la tabla">Buscar:</label>
            <input type="text" id="searchInput" name="search" 
                   class="form-control form-control-sm shadow-sm"
                   style="width:200px;" placeholder="Buscar..."
                   data-bs-toggle="tooltip" data-bs-placement="top"
                   title="Escribe para filtrar los resultados">
        </div>
    </div>

    <!-- Tabla de técnicas con sombra -->
    <div class="table-responsive shadow p-2 bg-white rounded">
        <table class="table table-striped table-bordered table-hover" id="tecnicasTable">
            <thead class="table-dark text-center">
                <tr>
                    <th data-bs-toggle="tooltip" data-bs-placement="top" title="Identificador único de la técnica">ID</th>
                    <th data-bs-toggle="tooltip" data-bs-placement="top" title="Nombre de la técnica">Nombre</th>
                    <th data-bs-toggle="tooltip" data-bs-placement="top" title="Nivel de dificultad (1-1000)">Nivel</th>
                    <th data-bs-toggle="tooltip" data-bs-placement="top" title="Fecha de creación de la técnica">Fecha Creación</th>
                    <th data-bs-toggle="tooltip" data-bs-placement="top" title="Última actualización de la técnica">Última Actualización</th>
                    <th data-bs-toggle="tooltip" data-bs-placement="top" title="Descripción detallada de la técnica">Descripción</th>
                    <th data-bs-toggle="tooltip" data-bs-placement="top" title="Acciones disponibles para cada técnica">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for producto in productos %}
                <tr>
                    <td class="text-center" 
                        data-bs-toggle="tooltip" data-bs-placement="top" 
                        title="ID: {{ producto.id }}">{{ producto.id }}</td>
                    <form method="POST" action="{{ url_for('editar_producto', id=producto.id) }}">
                        <td>
                            <input type="text" name="nombre" value="{{ producto.nombre }}"
                                class="form-control form-control-sm"
                                data-bs-toggle="tooltip" data-bs-placement="top"
                                title="Editar nombre de la técnica">
                        </td>
                        <td>
                            <input type="number" step="1" name="precio" value="{{ producto.precio }}"
                                class="form-control form-control-sm text-end" min="1" max="1000"
                                data-bs-toggle="tooltip" data-bs-placement="top"
                                title="Nivel entre 1 y 1000">
                        </td>
                        <td class="text-center small"
                            data-bs-toggle="tooltip" data-bs-placement="top" 
                            title="Fecha de creación: {% if producto.fecha_creacion %}{{ producto.fecha_creacion.strftime('%d/%m/%Y %H:%M') }}{% else %}N/A{% endif %}">
                            {% if producto.fecha_creacion %}
                                <span class="text-muted">
                                    {{ producto.fecha_creacion.strftime('%d/%m/%Y') }}
                                </span>
                                <br>
                                <small class="text-muted">{{ producto.fecha_creacion.strftime('%H:%M') }}</small>
                            {% else %}
                                <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td class="text-center small"
                            data-bs-toggle="tooltip" data-bs-placement="top" 
                            title="Última actualización: {% if producto.fecha_actualizacion %}{{ producto.fecha_actualizacion.strftime('%d/%m/%Y %H:%M') }}{% else %}N/A{% endif %}">
                            {% if producto.fecha_actualizacion %}
                                <span class="text-muted">
                                    {{ producto.fecha_actualizacion.strftime('%d/%m/%Y') }}
                                </span>
                                <br>
                                <small class="text-muted">{{ producto.fecha_actualizacion.strftime('%H:%M') }}</small>
                            {% else %}
                                <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td>
                            <input type="text" name="descripcion" value="{{ producto.descripcion }}"
                                class="form-control form-control-sm"
                                data-bs-toggle="tooltip" data-bs-placement="top"
                                title="Editar descripción de la técnica">
                        </td>
                        <td class="text-center">
                            <form method="POST" action="">
                                <button type="button" 
                                        class="btn btn-success btn-sm me-1 shadow-sm" 
                                        title="Guardar cambios"
                                        data-bs-toggle="tooltip" data-bs-placement="top"
                                        onclick="confirmarGuardado(this.form)">
                                    <i class="fas fa-save"></i>
                                </button>

                                <button type="button" 
                                        class="btn btn-danger btn-sm shadow-sm" 
                                        title="Eliminar técnica"
                                        data-bs-toggle="tooltip" data-bs-placement="top"
                                        onclick="confirmarEliminacion(this.form)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                        </td>
                    </form>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Paginación -->
    <div class="d-flex justify-content-between align-items-center mt-2">
        <div id="infoPagina" 
             data-bs-toggle="tooltip" data-bs-placement="top"
             title="Información de registros mostrados">Mostrando 1 a 10 de {{ productos|length }} registros</div>
        <nav>
            <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
        </nav>
    </div>

</div>

<!-- Scripts de confirmación -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Incluir SheetJS para Excel -->
<script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
<!-- Incluir jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>
    // Inicializar tooltips de Bootstrap
    document.addEventListener('DOMContentLoaded', function() {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Inicializar funcionalidades
        inicializarFuncionalidades();
    });

    function confirmarGuardado(form) {
        Swal.fire({
            title: '¿Deseas guardar los cambios?',
            text: 'Los cambios se aplicarán a esta técnica',
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#28a745',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Sí, guardar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                let input = document.createElement("input");
                input.type = "hidden";
                input.name = "accion";
                input.value = "guardar";
                form.appendChild(input);
                form.submit();
            }
        });
    }

    function confirmarEliminacion(form) {
        Swal.fire({
            title: '¿Estás seguro?',
            text: "¡Esta acción no se puede deshacer! La técnica será eliminada permanentemente.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                let input = document.createElement("input");
                input.type = "hidden";
                input.name = "accion";
                input.value = "eliminar";
                form.appendChild(input);
                form.submit();
            }
        });
    }

    function inicializarFuncionalidades() {
        const searchInput = document.getElementById('searchInput');
        const registrosSelect = document.getElementById('registrosSelect');
        const tableBody = document.querySelector('#tecnicasTable tbody');
        let allRows = Array.from(tableBody.querySelectorAll('tr'));
        const pagination = document.getElementById('pagination');
        const infoPagina = document.getElementById('infoPagina');
        let currentPage = 1;

        // ===== Filtrar y paginar =====
        function filtrarYPaginar() {
            const filter = searchInput.value.toLowerCase();
            const rowsPerPage = parseInt(registrosSelect.value);

            let filteredRows = allRows.filter(row => {
                const nombreInput = row.querySelector('input[name="nombre"]');
                const nombre = nombreInput ? nombreInput.value.toLowerCase() : '';
                const id = row.querySelector('td:first-child')?.textContent.toLowerCase() || '';
                const descripcionInput = row.querySelector('input[name="descripcion"]');
                const descripcion = descripcionInput ? descripcionInput.value.toLowerCase() : '';
                
                return id.includes(filter) || nombre.includes(filter) || descripcion.includes(filter);
            });

            const pageCount = Math.ceil(filteredRows.length / rowsPerPage);
            if (currentPage > pageCount) currentPage = 1;
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;

            allRows.forEach(row => row.style.display = 'none');
            filteredRows.slice(start, end).forEach(row => row.style.display = '');

            const showingStart = filteredRows.length === 0 ? 0 : start + 1;
            const showingEnd = Math.min(end, filteredRows.length);
            infoPagina.textContent = `Mostrando ${showingStart} a ${showingEnd} de ${filteredRows.length} registros`;

            // Actualizar tooltip de infoPagina
            infoPagina.setAttribute('data-bs-original-title', 
                `Mostrando registros ${showingStart} a ${showingEnd} de ${filteredRows.length} totales`);

            // Paginación
            pagination.innerHTML = '';
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" data-bs-toggle="tooltip" title="Página anterior">«</a>`;
            prevLi.addEventListener('click', () => { if (currentPage > 1) { currentPage--; filtrarYPaginar(); } });
            pagination.appendChild(prevLi);

            for (let i = 1; i <= pageCount; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" data-bs-toggle="tooltip" title="Ir a página ${i}">${i}</a>`;
                li.addEventListener('click', () => { currentPage = i; filtrarYPaginar(); });
                pagination.appendChild(li);
            }

            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === pageCount ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" data-bs-toggle="tooltip" title="Página siguiente">»</a>`;
            nextLi.addEventListener('click', () => { if (currentPage < pageCount) { currentPage++; filtrarYPaginar(); } });
            pagination.appendChild(nextLi);

            // Reinicializar tooltips de paginación
            var tooltipTriggerList = [].slice.call(pagination.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }

        searchInput.addEventListener('keyup', () => { currentPage = 1; filtrarYPaginar(); });
        registrosSelect.addEventListener('change', () => { currentPage = 1; filtrarYPaginar(); });
        filtrarYPaginar();

        // ===== BOTONES FUNCIONALES =====

        // 1. COPIAR TABLA
        document.getElementById('btnCopiar').addEventListener('click', () => {
            console.log('Botón copiar clickeado');
            let text = '';
            const headers = Array.from(document.querySelectorAll('#tecnicasTable thead th')).map(th => th.textContent);
            text += headers.join('\t') + '\n';
            
            allRows.forEach(row => {
                if (row.style.display !== 'none') {
                    const cells = Array.from(row.cells).map((cell, index) => {
                        // Saltar la última columna de acciones
                        if (index === row.cells.length - 1) return '';
                        
                        const input = cell.querySelector('input');
                        if (input) return input.value.trim();
                        return cell.textContent.trim();
                    });
                    text += cells.join('\t') + '\n';
                }
            });
            
            navigator.clipboard.writeText(text).then(() => {
                Swal.fire({
                    title: '¡Copiado!',
                    text: 'Tabla copiada al portapapeles',
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false
                });
            }).catch(err => {
                console.error('Error al copiar: ', err);
                // Fallback para navegadores antiguos
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                Swal.fire({
                    title: '¡Copiado!',
                    text: 'Tabla copiada al portapapeles',
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false
                });
            });
        });

        // 2. EXPORTAR A EXCEL
        document.getElementById('btnExcel').addEventListener('click', () => {
            console.log('Botón Excel clickeado');
            const ws_data = [];
            
            // Cabecera
            const headers = Array.from(document.querySelectorAll('#tecnicasTable thead th')).map(th => th.textContent);
            // Remover la última columna (Acciones)
            headers.pop();
            ws_data.push(headers);
            
            // Filas
            allRows.forEach(row => {
                if (row.style.display !== 'none') {
                    const rowData = Array.from(row.cells).map((cell, index) => {
                        // Saltar la última columna de acciones
                        if (index === row.cells.length - 1) return null;
                        
                        const input = cell.querySelector('input');
                        if (input) {
                            return input.value;
                        } else if (cell.classList.contains('small')) {
                            return cell.textContent.trim().replace(/\s+/g, ' ');
                        }
                        return cell.textContent.trim();
                    }).filter(cell => cell !== null); // Filtrar valores nulos
                    
                    ws_data.push(rowData);
                }
            });
            
            try {
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(ws_data);
                XLSX.utils.book_append_sheet(wb, ws, 'Técnicas');
                XLSX.writeFile(wb, 'tecnicas.xlsx');
                
                Swal.fire({
                    title: '¡Excel Generado!',
                    text: 'Archivo Excel descargado correctamente',
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false
                });
            } catch (error) {
                console.error('Error al generar Excel:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'No se pudo generar el archivo Excel',
                    icon: 'error',
                    timer: 1500
                });
            }
        });

        // 3. GENERAR PDF
        document.getElementById('btnPDF').addEventListener('click', () => {
            console.log('Botón PDF clickeado');
            
            // Verificar si jsPDF está disponible
            if (typeof window.jspdf === 'undefined') {
                Swal.fire({
                    title: 'Error',
                    text: 'La librería PDF no está disponible',
                    icon: 'error',
                    timer: 1500
                });
                return;
            }

            const { jsPDF } = window.jspdf;
            
            try {
                const doc = new jsPDF();
                
                // Título
                doc.setFontSize(16);
                doc.text('Lista de Técnicas', 105, 15, { align: 'center' });
                
                // Obtener datos de la tabla
                const headers = Array.from(document.querySelectorAll('#tecnicasTable thead th')).map(th => th.textContent);
                // Remover la última columna (Acciones)
                headers.pop();
                
                const rows = [];
                allRows.forEach(row => {
                    if (row.style.display !== 'none') {
                        const rowData = Array.from(row.cells).map((cell, index) => {
                            // Saltar la última columna de acciones
                            if (index === row.cells.length - 1) return null;
                            
                            const input = cell.querySelector('input');
                            if (input) return input.value;
                            return cell.textContent.trim();
                        }).filter(cell => cell !== null);
                        
                        rows.push(rowData);
                    }
                });
                
                // Generar tabla en PDF
                doc.autoTable({
                    head: [headers],
                    body: rows,
                    startY: 25,
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [44, 62, 80] }
                });
                
                doc.save('tecnicas.pdf');
                
                Swal.fire({
                    title: '¡PDF Generado!',
                    text: 'Archivo PDF descargado correctamente',
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false
                });
            } catch (error) {
                console.error('Error al generar PDF:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'No se pudo generar el archivo PDF',
                    icon: 'error',
                    timer: 1500
                });
            }
        });

        // 4. IMPRIMIR
        document.getElementById('btnImprimir').addEventListener('click', () => {
            console.log('Botón imprimir clickeado');
            
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            const tableHTML = document.getElementById('tecnicasTable').cloneNode(true);
            
            // Remover inputs y poner valores actuales
            const inputs = tableHTML.querySelectorAll('input');
            inputs.forEach(input => {
                const span = document.createElement('span');
                span.textContent = input.value;
                span.style.display = 'block';
                span.style.padding = '2px';
                input.parentNode.replaceChild(span, input);
            });

            // Remover botones de acciones
            const actionCells = tableHTML.querySelectorAll('td:last-child');
            actionCells.forEach(cell => {
                cell.innerHTML = '-';
            });

            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Lista de Técnicas - Impresión</title>
                    <style>
                        body { 
                            font-family: Arial, sans-serif; 
                            margin: 20px; 
                            color: #333;
                        }
                        h2 { 
                            text-align: center; 
                            color: #2c3e50; 
                            margin-bottom: 20px;
                            padding-bottom: 10px;
                            border-bottom: 2px solid #34495e;
                        }
                        table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin-top: 10px;
                        }
                        th, td { 
                            border: 1px solid #ddd; 
                            padding: 8px; 
                            text-align: left; 
                            font-size: 12px;
                        }
                        th { 
                            background-color: #34495e; 
                            color: white; 
                            font-weight: bold;
                        }
                        tr:nth-child(even) { 
                            background-color: #f8f9fa; 
                        }
                        @media print {
                            body { margin: 0; }
                            table { font-size: 11px; }
                            h2 { margin-top: 0; }
                        }
                        .no-print { display: none; }
                    </style>
                </head>
                <body>
                    <h2>Lista de Técnicas</h2>
                    <div>Fecha de impresión: ${new Date().toLocaleDateString()}</div>
                    ${tableHTML.outerHTML}
                    <script>
                        window.onload = function() {
                            window.print();
                            setTimeout(function() {
                                window.close();
                            }, 1000);
                        }
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        });

        console.log('Todas las funcionalidades inicializadas correctamente');
    }
</script>

<style>
    body {
        background-color: #f8f9fa;
    }

    .alert-tecnicas {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        color: white;
        font-weight: bold;
        font-size: 1.4rem;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        padding: 15px;
        border: none;
    }

    .table th,
    .table td {
        vertical-align: middle !important;
    }

    .btn-success {
        background-color: #28a745;
        border: none;
    }

    .btn-danger {
        background-color: #dc3545;
        border: none;
    }

    .shadow-sm {
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1) !important;
    }

    .shadow {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
    }

    .table-hover tbody tr:hover {
        background-color: rgba(52, 152, 219, 0.05);
    }

    .form-control:focus {
        border-color: #2c3e50;
        box-shadow: 0 0 0 0.2rem rgba(44, 62, 80, 0.1);
    }

    /* Estilos para las celdas de fecha */
    .small {
        font-size: 0.85rem;
    }

    .text-muted {
        color: #6c757d !important;
    }

    /* Botón COPIAR - Color Verde Azulado */
    .btn-copiar {
        background-color: #20c997;
        border-color: #20c997;
        color: white;
    }

    .btn-copiar:hover {
        background-color: #199d76;
        border-color: #199d76;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(32, 201, 151, 0.3);
    }

    /* Botón EXCEL - Color Verde */
    .btn-excel {
        background-color: #198754;
        border-color: #198754;
        color: white;
    }

    .btn-excel:hover {
        background-color: #146c43;
        border-color: #146c43;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(25, 135, 84, 0.3);
    }

    /* Botón PDF - Color Rojo */
    .btn-pdf {
        background-color: #dc3545;
        border-color: #dc3545;
        color: white;
    }

    .btn-pdf:hover {
        background-color: #b02a37;
        border-color: #b02a37;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
    }

    /* Botón IMPRIMIR - Color Naranja */
    .btn-imprimir {
        background-color: #fd7e14;
        border-color: #fd7e14;
        color: white;
    }

    .btn-imprimir:hover {
        background-color: #dc6502;
        border-color: #dc6502;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(253, 126, 20, 0.3);
    }

    /* Efectos de transición para todos los botones */
    .btn-copiar, .btn-excel, .btn-pdf, .btn-imprimir {
        transition: all 0.3s ease;
        font-weight: 500;
    }

    /* Tamaño consistente de iconos */
    .btn i {
        font-size: 1.1rem;
    }

    /* Estilos para tooltips personalizados */
    .tooltip {
        font-size: 0.85rem;
    }

    .tooltip-inner {
        background-color: #2c3e50;
        padding: 8px 12px;
        border-radius: 6px;
    }

    .tooltip.bs-tooltip-top .tooltip-arrow::before {
        border-top-color: #2c3e50;
    }

    .tooltip.bs-tooltip-bottom .tooltip-arrow::before {
        border-bottom-color: #2c3e50;
    }

    .tooltip.bs-tooltip-start .tooltip-arrow::before {
        border-left-color: #2c3e50;
    }

    .tooltip.bs-tooltip-end .tooltip-arrow::before {
        border-right-color: #2c3e50;
    }
</style>

{% endblock %}